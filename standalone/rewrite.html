<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Network</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" type="text/css">
    <style type="text/css">
        #mynetwork {
            width: 600px;
            height: 600px;
            border: 1px solid #357edd;
            border-radius: 0.5rem;
            background-color: rgba(255, 255, 255, 0.8);
        }
        #info {
            position: absolute;
            top: 1vw;
            left: 4vw;
            border: 3px solid #357edd;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px;
            z-index: 1;
            border-radius: 0.5rem;
            font-size: 0.8em;
        }
        p {
            line-height: 5px; 
            margin-top:1px;
        }
        p:last-of-type {
            margin-bottom: 1px;
        }
        input {
            color: #357edd;
            border: 3px solid #357edd;
            min-width: 6rem;
            border-radius: 0.5rem;
            font-size: 0.8em;
            min-height: 2rem;
        }
        input:hover {
            background-color: #357edd;
            color: white;
        }
        
    </style>
</head>
<body>
    <div id="page">
        <div id="mynetwork"></div>
        <div id="info">
            <p><b>Selected nodes:</b></p>
            <p>None</p>
        </div>
        <div id="buttons">
            <input type="button" id="uploadButton" value="Upload DOT file">
            <input type="button" id="clusterButton" value="Cluster nodes by DOT-defined clusters">
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var network, data;
            var totalSize;
            var selectedNode;
            var options = {
                interaction: {
                    multiselect: true
                },
                physics: {
                    enabled: true
                },
            };
            var page = document.getElementById("page");
            var container = document.getElementById("mynetwork");
            var info = document.getElementById("info");
            var buttons = document.getElementById("buttons");
            var defaultGraph = "digraph source_graph {\n" +
              "\trankdir=LR;\n" +
              "\tnode [shape=circle style=filled fixedsize=true fontsize=20];\n" +
              "\tsize=\"15\";\n" +
              "\n" +
              "\tnode [width=51 fillcolor=white bordercolor=black label=\"WordLog MainDoc\"] 1\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"TASKBAR\" cluster=\"SYSTEM\"] 2\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Untitled - Google Chrome\" cluster=\"GOOGLE\"] 3\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Google - Google Chrome\" cluster=\"GOOGLE\"] 4\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"wikipedia - Google Search - Google Chrome\" cluster=\"GOOGLE\"] 5\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Wikipedia - Google Chrome\" cluster=\"WIKIPEDIA\"] 6\n" +
              "\tnode [width=9 fillcolor=white bordercolor=black label=\"C++ - Wikipedia - Google Chrome\" cluster=\"WIKIPEDIA\"] 7\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Task Switching\" cluster=\"SYSTEM\"] 8\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Tab for a Cause - Google Chrome\" cluster=\"GOOGLE\"] 9\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"tab.gladly.io/newtab/ - Google Chrome\" cluster=\"GOOGLE\"] 10\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"java - Google Search - Google Chrome\" cluster=\"GOOGLE\"] 11\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"java.com/en/ - Google Chrome\"] 12\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Java | Oracle - Google Chrome\"] 13\n" +
              "\tnode [width=11 fillcolor=white bordercolor=black label=\"Save As\" cluster=\"SYSTEM\"] 14\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"New notification\" cluster=\"SYSTEM\"] 15\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"InputLog (Running) - Microsoft Visual Studio\"] 16\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"#welcome | Joshua's Discord Corner - Discord\"] 17\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Cpp_vs_JavaWordLog_Joshua_20230706145645.docx\"] 18\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"System tray overflow window.\" cluster=\"SYSTEM\"] 19\n" +
              "\tnode [width=5 fillcolor=white bordercolor=black label=\"Inputlog 9.5.0.1\"] 20\n" +
              "\n" +
              "\t1 -> 2 [label=\"3\" penwidth=3];\n" +
              "\t1 -> 8 [label=\"4\" penwidth=4];\n" +
              "\t1 -> 14 [label=\"1\" penwidth=1];\n" +
              "\t1 -> 18 [label=\"1\" penwidth=1];\n" +
              "\t2 -> 3 [label=\"1\" penwidth=1];\n" +
              "\t2 -> 15 [label=\"1\" penwidth=1];\n" +
              "\t2 -> 1 [label=\"1\" penwidth=1];\n" +
              "\t2 -> 19 [label=\"1\" penwidth=1];\n" +
              "\t3 -> 4 [label=\"1\" penwidth=1];\n" +
              "\t3 -> 9 [label=\"1\" penwidth=1];\n" +
              "\t4 -> 5 [label=\"1\" penwidth=1];\n" +
              "\t5 -> 6 [label=\"1\" penwidth=1];\n" +
              "\t6 -> 7 [label=\"1\" penwidth=1];\n" +
              "\t7 -> 8 [label=\"2\" penwidth=2];\n" +
              "\t7 -> 3 [label=\"1\" penwidth=1];\n" +
              "\t8 -> 1 [label=\"5\" penwidth=5];\n" +
              "\t8 -> 7 [label=\"2\" penwidth=2];\n" +
              "\t8 -> 16 [label=\"1\" penwidth=1];\n" +
              "\t8 -> 17 [label=\"1\" penwidth=1];\n" +
              "\t9 -> 10 [label=\"1\" penwidth=1];\n" +
              "\t9 -> 11 [label=\"1\" penwidth=1];\n" +
              "\t10 -> 9 [label=\"1\" penwidth=1];\n" +
              "\t11 -> 12 [label=\"1\" penwidth=1];\n" +
              "\t12 -> 13 [label=\"1\" penwidth=1];\n" +
              "\t13 -> 8 [label=\"1\" penwidth=1];\n" +
              "\t14 -> 1 [label=\"1\" penwidth=1];\n" +
              "\t15 -> 8 [label=\"1\" penwidth=1];\n" +
              "\t16 -> 2 [label=\"1\" penwidth=1];\n" +
              "\t17 -> 8 [label=\"1\" penwidth=1];\n" +
              "\t18 -> 1 [label=\"1\" penwidth=1];\n" +
              "\t19 -> 20 [label=\"1\" penwidth=1];\n" +
              "}\n";

            function initializeNetwork() {
                // Set up initial network settings
                page.style.marginLeft = window.innerWidth * 0.03 + "px";
                container.style.width = window.innerWidth * 0.94 + "px";
                container.style.height = window.innerHeight * 0.9 + "px";
                buttons.style.marginTop = window.innerHeight * 0.01 + "px";

                [network, data] = dotToNetwork(defaultGraph, options);
            }

            function loadDotFile() {
                // Create an input file
                var input = document.createElement("input");
                input.type = "file";

                // Add an event listener to the input file
                input.addEventListener("change", function() {
                    var reader = new FileReader();
                    reader.addEventListener("load", function() {
                        dotString = reader.result;
                        try {
                            network, data = dotToNetwork(dotString);
                        } catch (err) {
                            alert("Error loading network: " + err.message);
                        }
                    });
                    reader.readAsText(input.files[0]);
                });

                input.click();
            }

            function createNetwork() {
                var network = new vis.Network(container, data, options);
                network.on("selectNode", function (params) {
                    updateInfoBox(params.nodes);
                    openClusters(params.nodes);
                });

                network.on("deselectNode", function (params) {
                    updateInfoBox(params.nodes);
                });

                network.on("dragStart", function (params) {
                    updateInfoBox(params.nodes);
                    openClusters(params.nodes);
                });

                // Ensure nodes are fixed after dragging
                network.on("dragEnd", function (params) {
                    for (nodeId of network.getSelection().nodes) {
                        var node = network.body.data.nodes._data[nodeId];
                        network.body.data.nodes.update({id: node.id, fixed: node.fixed});
                    }
                })

                return network;
            }

            function updateInfoBox(nodes) {
                info.innerHTML = "<p><b>Selected nodes:</b><p>";
                if (nodes.length > 0) {
                    var selectedSize = 0;
                    for (nodeId of nodes) {
                        console.log(nodeId, network.isCluster(nodeId));
                        if (network.isCluster(nodeId) === false) {
                            var node = network.body.data.nodes._data[nodeId];
                            selectedSize += node.size;
                            info.innerHTML += `<p>${node.label}</p>`;
                        }
                    }
                    var selectedPercentage = Math.round(selectedSize / totalSize * 100);
                    info.innerHTML += `<p><b>Total size:</b> ${selectedSize}`;
                    info.innerHTML += `<p><b>Relative Time Spent:</b> ${selectedPercentage}%</p>`;
                } else {
                    info.innerHTML += "<p>None</p>";
                }
            }

            function openClusters(nodes) {
                for (node of nodes) {
                    if (network.isCluster(node) === true) {
                        network.openCluster(node); // TODO think we lose information on edge labels here, should be fixed
                        // reproduce behaviour by clustering the example network, then clicking on a cluster; all outgoing
                        // edges' labels are lost. Also, the to-cluster edge label is not correct (values don't seem to be added)
                        // we should have at least a value of 7 from MainDoc to SYSTEM but it says 3 (the number of nodes within the cluster our MainDoc node has an edge to)
                    }
                }
            }

            function createClusters() {
                // Cluster nodes based on DOT-defined clusters
                const clusters = data.nodes.reduce((acc, node) => {
                    if (node.cluster) {
                        if (!acc[node.cluster]) {
                            acc[node.cluster] = [];
                        }
                        acc[node.cluster].push(node.id);
                    }
                    return acc;
                }, {});

                // Return if no clusters are defined (so graph doesn't move around)
                var clusterCount = Object.entries(clusters).length
                if (clusterCount === 0) return;

                network = createNetwork();

                // Generate colors for each label
                var colors = generateColors(clusterCount) // TODO these could be pre-defined as well; currently they are deterministically 'random'
                for (const [label, nodes] of Object.entries(clusters)) {
                    var clusterOptionsByData = {
                        joinCondition: function (childOptions) {
                            return childOptions.cluster === label;
                        },
                        clusterNodeProperties: {
                            id: "cluster:" + label,
                            borderWidth: 3,
                            shape: "box",
                            color: colors.pop(),
                            label: `${label} (${nodes.length})`,
                        },
                    };
                    network.cluster(clusterOptionsByData);
                }
            }
            

            function dotToNetwork(dotString, options) {
                // Convert DOT string to network
                var data = vis.network.convertDot(dotString);
                modifyEdges(data.edges);
                modifyNodes(data.nodes);
                var network = createNetwork();

                return [network, data];
            }

            function modifyEdges(edges) {
                // Modify edges based on DOT-defined edge attributes
                for (var i = 0; i < edges.length; i++) {
                    // Rename penwidth to width
                    edges[i].width = edges[i].penwidth;
                    delete edges[i].penwidth;
                }
            }

            function modifyNodes(nodes) {
                totalSize = 0;
                // Modify nodes based on DOT-defined node attributes
                for (var i = 0; i < nodes.length; i++) {
                    // Rename width to size (use 5 if no width is defined)
                    nodes[i].size = nodes[i].width || 5;
                    totalSize += nodes[i].size;
                    delete nodes[i].width;

                    nodes[i].shape = "dot";
                    nodes[i].fixed = false;

                    nodes[i].color = nodes[i].color || {};
                    nodes[i].color.border = nodes[i].bordercolor || "black";

                    nodes[i].chosen = {
                        node: function(values, id, selected, hovering) {
                            selectedNode = nodes[id - 1]
                        }
                    }
                }
            }

            function generateColors(numColors) {
                // Generate colors for clusters
                var colors = [];
                var hueIncrement = 360 / numColors;

                for (var i = 0; i < numColors; i++) {
                    var hue = i * hueIncrement;
                    var color = 'hsl(' + hue + ', 85%, 65%)';
                    colors.push(color);
                }

                return colors;
            }

            // Initial setup
            // TODO: Currently doesn't work if I don't call initializeNetwork() twice, not sure why
            initializeNetwork();
            initializeNetwork();

            // Event listeners
            document.getElementById("clusterButton").addEventListener("click", createClusters);
            document.getElementById("uploadButton").addEventListener("click", loadDotFile);
            document.addEventListener("keydown", function(event) {
                if (event.code === "Space") {
                    for (nodeId of network.getSelection().nodes) {
                        var node = network.body.data.nodes._data[nodeId];
                        node.fixed = !node.fixed;
                        node.color = {background: (node.fixed ? "red" : "white"), border: "black" };
                        network.body.data.nodes.update({id: node.id, fixed: node.fixed, color: node.color});
                        console.log(node);
                    }

                }

                if (event.code === "Escape") {
                    network.unselectAll();
                    updateInfoBox([])
                }
            });
        });
    </script>
</body>
</html>